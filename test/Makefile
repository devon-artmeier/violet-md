# ------------------------------------------------------------------------------
# Common
# ------------------------------------------------------------------------------

include ../common.mk

# ------------------------------------------------------------------------------
# Paths
# ------------------------------------------------------------------------------

OUT_PATH             := out
OUT_PATH_EXISTS      := $(wildcard $(OUT_PATH))
SRC_PATH             := src
INCLUDE_PATH         := ../include
VIOLET_PATH          := ../out
BUILD_PATH           := $(OUT_PATH)/build

# ------------------------------------------------------------------------------
# Files
# ------------------------------------------------------------------------------

SRC                  := $(wildcard $(SRC_PATH)/*.asm)
OBJ                  := $(patsubst $(SRC_PATH)/%.asm,$(BUILD_PATH)/%.o,$(SRC))
DEPEND               := $(patsubst %.o,%.d,$(OBJ))
OUT                  := $(OUT_PATH)/violet_test.gen

# ------------------------------------------------------------------------------
# Tool flags
# ------------------------------------------------------------------------------

VASM_FLAGS           := $(VASM_FLAGS) -I$(INCLUDE_PATH) -I$(VIOLET_PATH)
VLINK_FLAGS          := $(VLINK_FLAGS) -T linker.link
MKASMDEP_FLAGS       := $(MKASMDEP_FLAGS) -i $(INCLUDE_PATH) -i $(VIOLET_PATH)

# ------------------------------------------------------------------------------
# Reserved rules
# ------------------------------------------------------------------------------

.PHONY: all clean violet

# ------------------------------------------------------------------------------
# Make all
# ------------------------------------------------------------------------------

all: violet $(OUT)

# ------------------------------------------------------------------------------
# Clean
# ------------------------------------------------------------------------------

clean:
ifneq ($(OUT_PATH_EXISTS),)
	@$(RMDIR) "$(OUT_PATH)"
endif

# ------------------------------------------------------------------------------
# Rules
# ------------------------------------------------------------------------------

$(OUT): $(OBJ) | $(OUT_PATH)
	$(LINK_MSG)
	@$(VLINK) $(VLINK_FLAGS) -o $@ $^
	@$(MDROMFIX) $(MDROMFIX_FLAGS) $@

$(OBJ): $(BUILD_PATH)/%.o: $(SRC_PATH)/%.asm | $(BUILD_PATH) $(DEPEND)
	$(ASSEMBLE_MSG)
	@$(VASM) $(VASM_FLAGS) -L $(patsubst %.o,%.lst,$@) -o $@ $<

$(DEPEND): $(BUILD_PATH)/%.d: $(SRC_PATH)/%.asm | $(BUILD_PATH)
	$(DEPEND_MSG)
	@$(MKASMDEP) $(MKASMDEP_FLAGS) -o $@ $(patsubst %.d,%.o,$@) $<

violet:
	@make -C ..

# ------------------------------------------------------------------------------
# Path rules
# ------------------------------------------------------------------------------

$(OUT_PATH):
	@$(MKDIR) "$@"

$(BUILD_PATH):
	@$(MKDIR) "$@"

# ------------------------------------------------------------------------------
# Dependencies
# ------------------------------------------------------------------------------

ifneq (clean,$(filter clean,$(MAKECMDGOALS)))
-include $(DEPEND)
endif

# ------------------------------------------------------------------------------